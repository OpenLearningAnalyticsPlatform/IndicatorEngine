<?xml version="1.0" encoding="UTF-8"?>

<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/webflow
		http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">


    <var name="indicatorName" class="com.indicator_engine.model.IndicatorNaming"/>

    <on-start>
        <evaluate expression="indicatorPreProcessor.initSelectNumberParametersObject()"
                  result="flowScope.selectNumberParameters" />
        <evaluate expression="indicatorPreProcessor.initAvailableOperations_DB()"
                  result="flowScope.availableOperations" />
    </on-start>

    <!-- By default, the first state is the start state. -->

    <view-state id="indicatorName" view="indicator_system/number/indicator_name" model="indicatorName">
        <binder>
            <binding property="indicatorName" required="true" />
        </binder>
        <transition on="indicatorNameEntered" to="definitionHome" />
    </view-state>

	<view-state id="definitionHome" view="indicator_system/new_indicator" model="availableOperations">
        <binder>
            <binding property="selectedOperation" required="true" />
        </binder>
        <transition on="operationSelected" to="retrieveOperation" />
	</view-state>

    <action-state id="retrieveOperation">
        <evaluate expression="indicatorPreProcessor.retrieveOperation(availableOperations)" />
        <transition on="NUMBER" to="selectEventParameters" />
        <transition on="CORRELATION" to="definitionHome" />
    </action-state>

    <view-state id="selectEventParameters" view="indicator_system/number/indicator_number_select_event" model="selectNumberParameters">
        <binder>
            <binding property="selectedSource" required="true" />
            <binding property="selectedPlatform" required="true" />
            <binding property="selectedAction" required="true" />
        </binder>
        <transition on="eventSelected" to="populateCategoryTypes" />
    </view-state>
    <action-state id="populateCategoryTypes">
        <evaluate expression="indicatorPreProcessor.initPopulateTypes(selectNumberParameters)"
                  result="selectNumberParameters.type" />
        <transition to="populateCategoryMajors" />
    </action-state>

    <action-state id="populateCategoryMajors">
        <evaluate expression="indicatorPreProcessor.initPopulateMajors(selectNumberParameters)"
                  result="selectNumberParameters.majors" />
        <transition to="populateCategoryMinors" />
    </action-state>

    <action-state id="populateCategoryMinors">
        <evaluate expression="indicatorPreProcessor.initPopulateMinors(selectNumberParameters)"
                  result="selectNumberParameters.minors" />
        <transition to="selectMinor" />
    </action-state>

    <view-state id="selectMinor" view="indicator_system/number/indicator_number_select_minor" model="selectNumberParameters">
        <binder>
            <binding property="selectedMinor" required="true" />
            <binding property="selectedMajor" required="true" />
            <binding property="selectedType" required="true" />
        </binder>
        <transition on="minorSelected" to="populateEntities" />
    </view-state>

    <action-state id="populateEntities">
        <evaluate expression="indicatorPreProcessor.initAvailableEntities_DB(selectNumberParameters.selectedMinor)"
                  result="selectNumberParameters.keys" />
        <transition to="selectEntities" />
    </action-state>

    <view-state id="selectEntities" view="indicator_system/number/indicator_number_select_entity" model="selectNumberParameters">
    <binder>
        <binding property="selectedKeys" required="true" />
        <binding property="entityValues[0].eValues" />
        <binding property="entityValues[1].eValues" />
        <binding property="entityValues[2].eValues" />
        <binding property="entityValues[3].eValues" />
        <binding property="entityValues[4].eValues" />
        <binding property="entityValues[5].eValues" />
        <binding property="entityValues[6].eValues" />
        <binding property="entityValues[7].eValues" />
        <binding property="entityValues[8].eValues" />
    </binder>
    <transition on="specifyEValues">
        <evaluate expression="indicatorPreProcessor.manageEValues(selectNumberParameters)"/>
    </transition>
    <transition on="clearEValues">
        <evaluate expression="indicatorPreProcessor.clearEValuesSpecifications(selectNumberParameters)"/>
    </transition>
    <transition on="entitySelected" to="calculateResult" />
    </view-state>

    <action-state id="calculateResult">
        <evaluate expression="operationNumberProcessor.computeResult(selectNumberParameters)"
                  result="selectNumberParameters.result" />
        <transition to="displayResult" />
    </action-state>

    <view-state id="displayResult" view="indicator_system/number/indicator_number_result" model="selectNumberParameters">
        <transition to="definitionEnd" />
    </view-state>

	<end-state id="definitionEnd" view="externalRedirect:contextRelative:/welcome"/>

</flow>
