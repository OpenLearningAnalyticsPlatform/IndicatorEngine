<?xml version="1.0" encoding="UTF-8"?>

<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/webflow
		http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">


    <var name="indicatorName" class="com.indicator_engine.model.IndicatorNaming"/>

    <on-start>
        <evaluate expression="indicatorPreProcessor.initSelectNumberParametersObject()"
                  result="flowScope.selectNumberParameters" />
        <evaluate expression="indicatorPreProcessor.initAvailableOperations_DB()"
                  result="flowScope.availableOperations" />
    </on-start>

    <!-- By default, the first state is the start state. -->
	<view-state id="definitionHome" view="indicator_system/new_indicator" model="availableOperations">
        <binder>
            <binding property="selectedOperation" required="true" />
        </binder>
        <transition on="operationSelected" to="retrieveOperation" />
	</view-state>

    <action-state id="retrieveOperation">
        <evaluate expression="indicatorPreProcessor.retrieveOperation(availableOperations)" />
        <transition on="NUMBER" to="indicatorName" />
        <transition on="CORRELATION" to="definitionHome" />
    </action-state>

    <view-state id="indicatorName" view="indicator_system/number/indicator_name" model="indicatorName">
        <binder>
            <binding property="indicatorName" required="true" />
        </binder>
        <transition on="indicatorNameEntered" to="selectMinor" />
    </view-state>

    <view-state id="selectMinor" view="indicator_system/number/indicator_number_select_minor" model="selectNumberParameters">
        <binder>
            <binding property="selectedMinor" required="true" />
        </binder>
        <transition on="minorSelected" to="populateEntities" />
    </view-state>

    <action-state id="populateEntities">
        <evaluate expression="indicatorPreProcessor.initAvailableEntities_DB(selectNumberParameters.selectedMinor)"
                  result="selectNumberParameters.keys" />
        <transition to="selectEntities" />
    </action-state>

    <view-state id="selectEntities" view="indicator_system/number/indicator_number_select_entity" model="selectNumberParameters">
    <binder>
        <binding property="selectedKeys" required="true" />
    </binder>
    <transition on="entitySelected" to="calculateResult" />
    </view-state>

    <action-state id="calculateResult">
        <evaluate expression="operationNumberProcessor.computeResult(selectNumberParameters)"
                  result="selectNumberParameters.result" />
        <transition to="displayResult" />
    </action-state>

    <view-state id="displayResult" view="indicator_system/number/indicator_number_result" model="selectNumberParameters">
        <transition to="definitionEnd" />
    </view-state>

	<end-state id="definitionEnd" view="externalRedirect:contextRelative:/welcome"/>

</flow>
